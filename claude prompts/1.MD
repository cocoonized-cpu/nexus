# Claude Code Prompt — NEXUS “No-Partial” Remediation & Feature Completion

You are **Claude Code** operating on the **NEXUS** repository. Your mission is to **fully** implement and validate the changes below across UI + backend + workers + database + realtime pipelines, with **zero partial delivery**.

## Non-negotiables
1. **No partial implementation**. Do not stop at “most of it works.” This must be complete.
2. **100% spec adherence**. If anything deviates from the spec (including Whitepaper.md), you must **report it explicitly** and fix it (or propose the smallest spec-aligned change and ask for approval if the spec conflicts with reality).
3. **Full codebase review** before changing anything major: map architecture, data flow, and realtime update mechanism(s).
4. **Ask questions when needed** (and only when needed): if any requirement is ambiguous or conflicts with existing design, ask crisp questions and block until answered.
5. **Implement + test**. Your final response must include evidence: what tests were added/updated, what was executed, and results.
6. **Do not return early**. Only return once everything is implemented, verified, and the app runs end-to-end.

---

## First actions (must do)
### 1) Initialize parallel agents (run in parallel)
Spin up multiple agents and keep them coordinated. Use the available skills

### 2) Create a working plan + acceptance checklist
Before coding, produce a checklist that maps **each bullet requirement** to:
- files/components/services affected
- API endpoints / sockets
- DB changes
- tests to add
- definition of done

### 3) Identify spec source of truth
- Read **NEXUS_Whitepaper.md** completely and treat it as authoritative for bot behavior.
- If any feature request conflicts with Whitepaper.md or current behavior, **flag immediately** with exact file/line references.

---

## Clarifying questions (ask only if blocked)
Ask only if any of these are unknown after repo recon:
1. What is the canonical meaning of **“engaged”** (UI toggle? config? API state)? Where is it stored?
2. Which exchanges/data sources are supported for **funding rates and prices**? Where do these streams originate?
3. Do we already have a websocket/SSE channel? If yes, what topics exist; if no, which is preferred?
4. What should be the retention policy for **interactions/system events** (DB size considerations)?
5. What is the desired time horizon/model for **forecasted funding rate & spread** (simple projection vs existing model)? If Whitepaper.md specifies, follow it; otherwise implement a reasonable baseline forecast and make it toggleable.

If none of these block, proceed without asking.

---

## Implementation requirements (must match exactly)

# 1) Dashboard
- **Remove “Active Positions”** from the right side of the screen (entirely).
- Ensure **every KPI Card** includes a short explanation/tooltip/subtext describing exactly what it shows.
- **Expand the TOP Opportunities matrix** across the full width of the main viewable area.

**DoD**
- Layout visually uses available width; no empty right column due to removed block.
- KPI explanations exist on all KPI cards (no exceptions).
- Regression test / UI snapshot test where applicable.

---

# 2) Situation Room
- **Remove Risk Overview completely** (UI + any dependencies).
- **Expand System Status** across full page width.
- Add **System Log panel next to System Status** showing **all docker logs in real time**.
  - Must be realtime streaming (not manual refresh).
  - Must handle reconnects gracefully and show connection status.
- **Activity log** at the bottom must include **relevant system events**.
  - Currently only “source opportunity” events appear; fix so events from **all background workers that touch opportunities** are logged.
  - End user must see what’s happening across the whole pipeline.

**DoD**
- Risk Overview is gone (no dead code paths).
- Docker logs stream live in UI.
- Activity log shows events from all relevant workers with clear source metadata.

---

# 3) Opportunities
- Clicking the **symbol** opens the **detailed positions view** for that symbol:
  - shows **historical funding rates and prices**
  - page must refresh **in realtime** when new backend funding rates arrive
- When bot is engaged and starts to action opportunities:
  - **flag them appropriately**
  - **change row background color** so user knows bot is managing this symbol
- Remove Status filter (**All, Active, Executed**). It’s not working:
  - Replace with: **every column searchable, sortable, and filterable**
- Move content of the **Details modal** into the **positions detail page** in a separate section.

**DoD**
- Symbol click always routes to the detail page (no modal fallback).
- Realtime updates verified by test or dev harness.
- Table search/sort/filter works per column.
- “Bot managing” state is correct and persists based on backend state.

---

# 4) Positions
- **Reset positions in the database**; system currently has many orphans.
  - Provide a safe reset procedure: script/migration + documentation.
  - Ensure referential integrity afterwards.
- Add buttons on right side of table:
  - **Blacklist**: never trade a blacklisted symbol/position (must enforce in bot logic + UI)
  - **Details**: opens details page (historical funding, prices, opportunities, everything known)
  - **Interactions**: new modal/page showing every interaction the bot had with the position/opportunity
    - Every worker interaction must record an entry (including read-only checks)
    - Must form a granular per-position timeline with human-readable narratives
    - Provide sensible visualization suggestion and implement it (timeline is preferred)
    - Example entries:
      - “Funding Rate declined over last X data points… waiting X iterations…”
      - “Funding Rate payout soon… likely achieve XX USD…”
      - “Keeping position open… stable behavior…”
    - Must include timestamps, worker name, correlation IDs (positionId/opportunityId), and a short “reason/action”.

**DoD**
- Orphans removed; DB consistent; bot unaffected by reset.
- Blacklist stored persistently and enforced everywhere opportunities are chosen/acted.
- Interactions timeline is populated and visible and includes events from all relevant workers.

---

# 5) Position Details
- Always update funding rates and prices in **realtime**.
  - The **chart updates automatically** and **every KPI** updates when data updates.
- Page must open with the **left side menu navigation bar** visible (consistent app shell).
- Include **forecasted funding rate and spread line**, toggleable on/off.

**DoD**
- Verified realtime pipeline: change arrives → backend persists/publishes → UI updates.
- Forecast overlay toggle works and persists (session-level is fine unless settings specify otherwise).

---

# 6) Performance (replace completely)
Current Performance page is non-functional. Remove and rebuild from scratch with only:

- **Balances** across all exchanges for all currencies
  - current + historical
- **Performance of trades**
  - current + historical
- **Performance of captured funding rates**
  - current + historical

Nothing else.

**DoD**
- New page routes correctly, loads data, handles empty states.
- Historical views are present (charts/tables).
- Backend endpoints + models exist and are tested.

---

# 7) Risk
- Remove the Risk page completely (routing, nav item, code, tests).

**DoD**
- No dead links; no route references.

---

# 8) Settings
- Reimagine, reorder, and package settings so it’s easy to understand.
- Ensure **every configuration item is actually implemented** in bot logic/workers.
  - If not implemented: **disable it in UI** (and ideally mark as “Not implemented”).
- Settings must be validated (types/ranges), and changes must take effect.

**DoD**
- Settings page is coherent, grouped, and truthful.
- No “fake settings” that do nothing.

---

# 9) General Bot Behavior (Whitepaper.md compliance)
- Once engaged, bot must take up to **5 open NEXUS positions** (based on settings).
- Must choose the **most profitable opportunities** identified.
- Once positions opened, bot must **constantly and in realtime monitor** positions for funding rate spread decline etc.
- Must follow logic in **Whitepaper.md** exactly.
- If bot is not currently 100% per Whitepaper.md, you must:
  1) identify deviations with file/line references
  2) fix them
  3) add tests proving compliance
  4) report what changed

**DoD**
- Deterministic tests or scenario tests covering:
  - opportunity ranking selection
  - max positions cap from settings
  - transition opportunity → position
  - monitoring loop behavior and decisions per Whitepaper.md
  - blacklist behavior
  - event emission into activity + interactions logs

---

## Realtime, events, logs — technical requirements
- Prefer existing realtime tech (websocket/SSE) used by the repo; don’t invent a second mechanism unless unavoidable.
- All “system events” must have:
  - timestamp
  - source worker/service
  - entity references (opportunityId/positionId/symbol)
  - severity/info level
  - human-readable message
- Docker logs:
  - Must stream from backend to UI in realtime
  - Must be secured (authz) and bounded (tail N lines on connect + stream forward)
  - Must not freeze UI; implement virtualized list if needed

---

## Testing requirements (must do)
- Add/extend tests at appropriate layers:
  - unit tests for ranking/selection/monitor logic
  - integration tests for event logging + interactions persistence
  - UI tests for table filter/sort/search and page removals
  - realtime update test/harness (mock stream or in-memory pubsub)
- Ensure CI/test command passes locally.

---

## Delivery format (final response must include)
1. **Summary of changes** by page/module.
2. **Checklist** mapping each requirement → implemented evidence (files, tests).
3. **How to run**:
   - dev startup
   - migrations/reset script
   - tests
4. **Explicit callouts**:
   - any deviations found vs Whitepaper.md and how you resolved them
   - any remaining risks (should be none for requested scope)

---

## Working rules
- Make small, safe commits (or a clear commit plan) to avoid breaking the app.
- Remove dead code when removing pages/features.
- Maintain consistent styling and navigation.
- Use clear naming and add inline docs only where it prevents future bugs.

---

## Start now
Proceed with repo recon, spin up the agents, build the checklist, then implement everything end-to-end and do not return until all tests pass and all requirements are met.